<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head><meta http-equiv="content-type" content="text/html;charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
body {line-height: 1.5; padding: 4em 1em;}
h2 {margin-top: 1em; padding-top: 1em;}
.cl{border-style:solid; border-width:1px; text-align:center; width:100px;} .cl a {text-decoration:none;}
.dl{border-style:solid; border-width:1px; text-align:center; width:50px;}
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode, table.sourceCode pre { margin: 0; padding: 0; border: 0; vertical-align: baseline; border: none; }
td.lineNumbers { border-right: 1px solid #AAAAAA; text-align: right; color: #AAAAAA; padding-right: 5px; padding-left: 5px; } td.sourceCode { padding-left: 5px; }
.sourceCode span.kw { color: #007020; font-weight: bold; } .sourceCode span.dt { color: #902000; } .sourceCode span.dv { color: #40a070; } .sourceCode span.bn { color: #40a070; } .sourceCode span.fl { color: #40a070; } .sourceCode span.ch { color: #4070a0; } .sourceCode span.st { color: #4070a0; } .sourceCode span.co { color: #60a0b0; font-style: italic; } .sourceCode span.ot { color: #007020; } .sourceCode span.al { color: red; font-weight: bold; } .sourceCode span.fu { color: #06287e; } .sourceCode span.re { } .sourceCode span.er { color: red; font-weight: bold; }
</style>
<title>Маппинг памяти NES</title>
<link rel="icon" type="image/png" href="../../files/favicon.png" />
</head><body>
<div style="position:absolute; top:0; bottom:0; left:0; width:25%; text-align: right">
<img src="../../files/head.svg" width="90%" alt="SVG not supported" /></div>
<div style=" margin: 0 auto; font-size: medium; width: 50%; text-align: justify; color: black; font-family: 'Georgia', serif;">
 <table cellpadding="3" cellspacing="3"><tbody><tr> 
 <td class="cl">  <a href="../../">NEWS</a> </td>
 <td class="cl">  <a href="../../doc/">ARTiCLES</a> </td>
 <td class="cl">  <a href="../../passgen/">PASSGENS</a> </td>
 <td class="cl">  <a href="../../archive.html">ARCHiVE</a> </td>
 <td class="cl">  <a href="../../about.html">ABOUT</a> </td>
 </tr></tbody></table>
 <h1>Маппинг памяти NES</h1>
<p><strong>Введение</strong>.<br />
Существует множество документов, повествующих на тему 6502 и ассемблерного хакинга игр NES. Они хорошо описывают как можно модифицировать игровой код, чтобы он делал что-нибудь новое. Некоторые даже рассказывают как вставить свой собственный код и прыгнуть к нему, добавляя к своему хаку новые возможности. Однако есть область, играющая решающее значение в понимании всего этого, которая либо мало объяснена, либо не освещена вообще. У читателей возникало множество вопросов.<br />
Я говорю, разумеется, о мапперах. Часто встречаются такие выражения, как “маппер” или “банкование PRG”, однако мало кто знает, что это означает или как это работает. Если вы не принадлежите к этой группе людей, надеюсь, документ прольёт свет на этот вопрос.<br />
В основном, этот документ будет рассказывать о переключениях PRG/CHR банков мапперами. Другие аспекты, связанные с мапперами (такие как генерирование IRQ, зеркалирование, звук и т.п.) здесь описаны не будут.</p>
<p><strong>Что вам нужно знать?</strong> Этот документ не будет рассказывать о процессоре 6502. Предполагается, что читатель знаком с ним, сомневаюсь, что большая часть информации будет вам полезна, если это не так.<br />
Однако вы можете ничего не знать об архитектуре NES и документ немного расскажет об основных областях взаимодействия маппера и приставки.<br />
Хотя и предполагается, что вы не очень опытны в этом вопросе, но чтобы хорошо усвоить информацию, возможно, вам придётся несколько раз перечитать документ.<br />
<strong>Смещения в ROMе против Адресов CPU</strong><br />
Смещение в ROMе и адрес CPU (центральный процессор NES) - две абсолютно разные вещи. Первый показывает позицию в .nes файле, тогда как второй показывает положение в памяти CPU. Мапперы - ключ к переходу от первого ко второму и наоборот. В этом документе… Смещения в ROMе будут с префиксом ‘0x’, а адреса CPU - с ‘$’.<br />
Между прочим, некоторые документы и туториалы ошибочно называют адреса CPU “смещениями в RAM (ОЗУ)” (фактически, это можно увидеть и в FCEUXD). Хочется поправить авторов этих документов, так как этот термин неверен и не подходит к нашей ситуации (мы не всегда имеем дело именно с RAM и это не совсем “смещение” от чего-то). Убедительно прошу удерживаться от употребления такого термина, и просто использовать слово “адрес” для адресов CPU и “смещение” для смещений ROMа. Может показаться, что тут большой разницы нет, но в дальнейшем могут возникнуть сложности, если нужно будет различать что является RAM, а что нет (и когда приходится иметь дело с настоящими смещениями в RAM).</p>
<p><strong>Взгляд на распределение памяти NES </strong>.<br />
Первый шаг к пониманию первичной функции мапперов (маппинг памяти) - изучение распределения памяти NES. Возможно, вы видели подобные таблицы и в других документах по NES, но обычно в них пространства картриджа и NES слиты воедино: Распределение памяти CPU NES:</p>
<pre><code>     +-------------+-----------------------------+

     | Адрес       |  Закреплено за              |

     +-------------+-----------------------------+

     |$0000 - $1FFF|  RAM (ОЗУ) системы          |

     |$2000 - $3FFF|  Регистры PPU               |

     |$4000 - $401F|  Регистры CPU/pAPU/Джойстика|

     |$4020 - $FFFF|  Картридж                   |

     +-------------+-----------------------------+</code></pre>
<p>NES не может адресовать больше, чем $FFFF<br />
Типичное распределение памяти картриджа:</p>
<pre><code>     +-------------+----------------------------------------+

     | Адрес       |  Закреплено за                         |

     +-------------+----------------------------------------+

     |$4020 - $5FFF|  Unused                                |

     |$6000 - $7FFF|  PRG-RAM (aka SRAM)                    |

     |$8000 - $FFFF|  PRG-ROM (т.е. непостредственно игра)  |

     +-------------+----------------------------------------+</code></pre>
<p>Так обстоит дело в подавляющем большинстве игр NES. Распределение памяти CPU, описаное выше, *всегда* одно и то же. Однако распределение памяти картриджа может сильно разниться в зависимости от типа маппера и картриджа.<br />
Что это означает? Ну, это значит, что каждый раз, когда игра читает или записывает в ячейку ниже $4020, она ничего не делает внутри приставки. Но это означает, что игра получает доступ к чему-то на картридже и это предмет вешательства маппера:</p>
<pre><code>LDA $0300   ;  чтение из системного ОЗУ NES
LDA $8123   ;  чтение из картриджа (скорее всего, PRG-ROM)</code></pre>
<p><strong>Взгляд на .nes ROM файл</strong><br />
Следующий шаг к пониманию как маппер распределяет информацию картриджа - понять что он непосредственно распределяет. Здесь все просто… .nes файл состоит из трех основных частей:</p>
<ol style="list-style-type: decimal">
<li>iNES Хэдер (заголовок)</li>
<li>PRG-ROM</li>
<li>CHR-ROM (если он есть у игры)</li>
</ol>
<p>Размеры PRG и CHR ROMов указыны в заголовке.<br />
iNES заголовок размером в $10 байт. Это означает, что PRG-ROM начинается по смещению 0x00010 в файле .nes.</p>
<p><strong>Зачем нужен маппер?</strong><br />
В качестве первого примера… Разберем небольшую и простую игру, вроде Super Mario Bros. У этого ROMа один PRG банк размером 32K. Это легко увидеть, загрузив игру в FCEUXD, и перейдя: Help | Message Log (там будет сказано “2 x 16KiB”)<br />
32K - это $8000 байт. Этот объем ИДЕАЛЬНО впишется в обычную память картриджа. Для этого частного случая… Маппер не нужен вовсе, потому что весь PRG может быть полностью размещен в отведенное пространство: <span class="math inline">8000−</span>FFFF. Это означает, что если игра читает из ячейки по адресу $8000, то чтение производится по по смещению 0x00010 (первый байт PRG-ROM).<br />
Однако, заметьте, что это пространство - ВСЯ память, которая предназначена для PRG-ROM. Тогда как же игры способны разместить гораздо больше PRG? Это достигается действиями мапперов, называемыми переключением PRG банков. Но перед тем, как перейти к переключению PRG банков… Давайте начнём с чего-нибудь понагляднее…</p>
<p><strong>Переключение CHR банков</strong><br />
Переключение CHR банков работает по тому же принципу, что и PRG, только… Здесь переключаются CHR банки, а не PRG, и это гораздо нагляднее.<br />
Игра Super Mario Bros. 2 - хороший пример. Загрузите ROM в FCEUXD и начните первый уровень, затем откройте PPU Viewer (Tools | PPUViewer). Теперь загрузите ROM в ваш любимый тайловый редактор и перейдите по смещению 0x26010. Заметьте как анимируются тайлы в нижней части правой таблицы тайлов в FCEUXD. Если вы теперь обратите внимание на то, как расположены анимирующие тайлы в тайловом редакторе, то станет ясно: игра просто циклически меняет блок тайлов с одного на другой.<br />
Это великолепная демонтрация того, что понимается под переключение банков и как оно работает. Попробуйте увидеть в таблицах тайлов не кучу разных тайлов, а некоторые “слоты”:</p>
<pre><code>    +----------------------------++----------------------------+

   |           Слот 0           ||           Слот 4           |

   |                            ||                            |

   +----------------------------++----------------------------+

   |           Слот 1           ||           Слот 5           |

   |                            ||                            |

   +----------------------------++----------------------------+

   |           Слот 2           ||           Слот 6           |

   |                            ||                            |

   +----------------------------++----------------------------+

   |           Слот 3           ||           Слот 7           |

   |                            ||                            |

   +----------------------------++----------------------------+</code></pre>
<p>В каждом слоте по 4 ряда тайлов (64 тайла)… В сумме 1к ($400 байт) в CHR. NES не может “увидеть” больше 8к за раз (больше 8 слотов). Однако… Игры могут иметь и больше графики, подсовывая разные “банки” CHR в эти слоты. Когда игре нужно подложить другой CHR банк в слот, она “переключает” на новый банк. Банк, который был раньше видимым, теперь убран и видимым становится новый банк.<br />
SMB2 постоянно переключает банки в слотах 6 и 7 - получается, что тайлы в этих слотах анимируются. Такой способ анимации довольно распространен в играх NES. Сами банки можно увидеть в тайловом редакторе. CHR-ROM в SMB2 начинается по смещению 0x20010, это значит:</p>
<pre><code>банк $00 = 0x20010 - 0x2040F   (первые 64 тайла)
банк $01 = 0x20410 - 0x2080F   (следующие 64 тайла)
банк $02 = 0x20810 - 0x20C0F
...
банк $7F = 0x3FC10 - 0x4000F   (последние 64 тайла)

(Все это справедливо для банков размером в 1k)</code></pre>
<p>Замечание о CHR-RAM:<br />
Некоторые игры используют вместо CHR-ROM CHR-RAM (у них совсем нет CHR-ROM, а вся графика содержится в PRG. Это можно встретить в таких играх, как Castlevania и Final Fantasy). Для таких игр все вышесказанное несправедливо.Работа с CHR-RAM несколько отличается от работы с CHR-ROM и это тема отдельного документа (скорее, это связано с регистрами PPU, чем с мапперами).</p>
<p><strong>Переключение PRG банков</strong><br />
Многие в состоянии легко усвоить суть переключения CHR банков, но испытывают сложности с PRG. Это довольно странно, потому что суть ОДНА И ТА ЖЕ. Только нужно смотреть на данные по адресам <span class="math inline">8000−</span>FFFF CPU как на большой кусок данных из PRG… Взгляните на эту серию слотов. Это типичное распределение памяти CPU NES:</p>
<pre><code>
     $0000  +-------------------+      $8000  +-----------------+

           |                   |             |                 |

           |  RAM системы      |             |  PRG Слот 0     |

           |                   |             |                 |

    $2000  +-------------------+      $A000  +-----------------+

           |                   |             |                 |

           | Регистры PPU      |             |  PRG Слот 1     |

           |                   |             |                 |

    $4000  +-------------------+      $C000  +-----------------+

           |Регистры CPU и т.д.|             |                 |

    $5000  +-------------------+             |  PRG Слот 2     |

           |  Не используется  |             |                 |

    $6000  +-------------------+      $E000  +-----------------+

           |                   |             |                 |

           |  SRAM             |             |  PRG Слот 3     |

           |                   |             |                 |

           +-------------------+             +-----------------+</code></pre>
<p>Точно так же, как при переключении CHR банков слоты заполнялись банками, состоящими из тайлов… При переключении PRG банков слоты заполняются банками PRG.<br />
NES не может “увидеть” больше 32k PRG данных за раз… Однако, переключая различные PRG банки, возможен доступ к гораздо большему, чем 32k объему данных.<br />
Аналогично тому, как расположены CHR банки в .nes файле, PRG банки:</p>
<pre><code>банк $00 = 0x00010 - 0x0200F
банк $01 = 0x02010 - 0x0400F
банк $02 = 0x04010 - 0x0600F
...
и т.д.

(Все это справедливо для банков размером в 8k)</code></pre>
<p><strong>Перевод из Смещения ROM в Адрес CPU и наоборот</strong><br />
Ассемблерный код 6502 и игры NES умеют обращаться только с адресами CPU. И никогда не имеют дела со смещениями в ROM. Поэтому указатели NES так непонятны для новичков. Например, человек получает указатель “63 91” и не может понять, почему он указывает на ячейку по смещению 0x15173. Если принять во внимание все вышесказанное, то все становится предельно ясно:</p>
<ul>
<li>“63 91” = $9163 (адрес CPU)</li>
<li>$9163 в “Слоте 0” ($8000-9FFF)</li>
<li>$9163 смещено на $1163 байт от начала слота (начало в $8000)</li>
<li>Для того, чтобы указывать на 0x15173… Банк $0A (если банки размером в 8k) должен быть переключен в слот 0:</li>
</ul>
<pre><code>$0A * $2000 = 0x14000      (№ банка * размер банка = начало банка)
0x14000 + $1163 = 0x15163  (начало банка + объем байтов в слоте = смещение)
0x15163 + 0x10 =  0x15173  (прибавили размер заголовка iNES)</code></pre>
<p>Этот же самый поинтер, тем не менее, мог бы указывать и на 0x0D173, и на 0x05173, и на 0x11173. Все зависит от того, какой банк переключен.<br />
Итак, как же узнать какой банк включен сейчас? Это довольно просто выяснить в FCEUXD. Просто откройте хексредактор (Tools | Hex Editor), перейдите View | NES Memory, затем к интересующему вас адресу CPU, щелкните на нем правой кнопкой, выберите “Go Here In ROM File”. Редактор перейдет в режим показа данных ROM и покажет вам смещение нужного PRG банка.<br />
Однако, игры ПОСТОЯННО переключают PRG банки. Не редкость, когда банки переключаются несколько раз за фрейм. Поэтому рекомендуется остановить отладчик в нужное время перед тем, как выяснять какой банк включен в данный момент. И помните: то, что банк включен сейчас не означает, что он будет включен по этому же адресу и позднее. Углубленно на эту тему можно прочитать в моем документе по поинтерам NES.</p>
<p><strong>Различные размеры слотов, переключаемые и непереключаемые слоты</strong><br />
До этого момента мы рассматривали примеры с банками по 8k. Потому что самый распространенный маппер (MMC3, mapper 4) использует PRG банки объемом 8k. Однако другие мапперы могут использовать банки иных размеров. А некоторые даже позволяют игре ВЫБИРАТЬ размер банков.<br />
Разные размеры банков работают довольно предсказуемо. Банки по 16k ($4000 байт) будут храниться в ROM так:</p>
<pre><code>банк $00 = 0x00010 - 0x0400F
банк $01 = 0x04010 - 0x0800F
... и т.д.</code></pre>
<p>А банки по 32k ($8000 - да, некоторые мапперы оперируют такими большими банками) будут храниться так:</p>
<pre><code>банк $00 = 0x00010 - 0x0800F
банк $01 = 0x08010 - 0x1000F
... и т.д.</code></pre>
<p>Итак, слоты соотносятся следующим образом:</p>
<pre><code>
            8k         16k         32k

$8000   +--------+  +--------+  +--------+

        |        |  |        |  |        |

$A000   +--------+  |        |  |        |

        |        |  |        |  |        |

$C000   +--------+  +--------+  |        |

        |        |  |        |  |        |

$E000   +--------+  |        |  |        |

        |        |  |        |  |        |

        +--------+  +--------+  +--------+</code></pre>
<p>Мапперы не всегда позволяют выбирать игре в какой слот переключать банк. Некоторые слоты фиксированы и в них всегда содержится один и тот же банк. Обычно эти слоты называют “hardwired” слотами (этот термин не совсем корректен… Скорее, это “fixed” слоты). Обычно последний слот жестко закрепляется за последним банком PRG, который не может быть переключен. Все зависит от того, какой маппер применен и, возможно, от установок маппера.</p>
<p><strong>Специфичные особенности некоторых мапперов</strong><br />
Все, что было сказано до этого момента относится ко всем мапперам. Однако каждый маппер имеет свои небольшие отличия в расположении слотов, способности переключения PRG/CHR банков, переключаемых и непереключаемых слотах и даже несколько других особенностей, не описанных в данном документе. И так как изложенная информация довольно общая, наверное, вы хотели бы знать детали.<br />
Итак, вот короткий список несокльких самых распространенных мапперов и их особенностей. Это ни в коем случае не полный список, я и не пытаюсь таковой создать. Есть и другие источники по этой информации, так что если ваша игра, имеет другой маппер, не описанный здесь, вам придется поискать где-нибудь еще.<br />
Этот список также не содержить детального описания регистров мапперов. Если вам нужно знать как вручную переключить банк или сделать что-нибудь другое, вам лучше обратиться к другому техническому документу по вашему мапперу. Выяснить какой маппер у вашей игры довольно просто. Многие эмуляторы выдают информацию по загруженному ROM. В FCEUXD после загрузки ROM, нужно перейти Help | Message Log, там можно увидеть и номер маппера.</p>
<ul>
<li>Маппер 0 – NROM<br />
Маппер 0 означает отстутствие маппера. Нет возможности переключения PRG/CHR банков.</li>
<li><p>Маппер 1 – MMC1<br />
Маппер 1 позволяет игре выбирать между тремя различными схемами переключениий. 99% игр, использующих этот маппер, применяют первую схему:</p>
<pre><code>PRG:

16k Слот @ $8000 = Переключаемый
16k Слот @ $C000 = Закреплен за последним PRG банком
---------ИЛИ--------
16k Слот @ $8000 = Закреплен за первым PRG банком (банк 0)
16k Слот @ $C000 = Переключаемый
---------ИЛИ--------
32k Слот @ $8000 = Переключаемый</code></pre>
<p>1 Маппер также позволяет игре выбирать из двух различных схем переключения CHR банков. Однако, многие игры, использующие этот маппер имеют только CHR-RAM. Для тех, которые его не имеют:</p>
<pre><code>CHR:
4k Слот @ ppu$0000 = Переключаемый
4k Слот @ ppu$1000 = Переключаемый
---------ИЛИ--------
8k Слот @ ppu$0000 = Переключаемый</code></pre>
Но существует несколько редких исключений, которые переназначают закрепленные банки странным образом. Dragon Warrior 4, например, нарушает правила переключения PRG банков. Для таких игр обратитесь к техническим документам по MMC1.<br />
</li>
<li><p>Маппер 2 – UxROM<br />
Маппер2 - очень прост. Только одна схема переключения. У всех игр, использующих этот маппер есть только CHR-RAM, поэтому CHR банки им переключать не надо.</p>
<pre><code>PRG:

16k Слот @ $8000 = Переключаемый
16k Слот @ $C000 = Закреплен за последним PRG банком</code></pre></li>
<li><p>Маппер 4 – MMC3<br />
MMC3 - безусловно, самый распространенный маппер. Практически, какую бы вы игру не взяли (если она была выпущена в США), она будет использовать MMC3. У большинства игр на этом маппере есть CHR-ROM и переключается он следующим образом:</p>
<pre><code>PRG:

8k Слот @ $8000 = Переключаемый
8k Слот @ $A000 = Переключаемый
8k Слот @ $C000 = Закреплен за предпоследним PRG банком
8k Слот @ $E000 = Закреплен за последним PRG банком
----------ИЛИ----------
8k Слот @ $8000 = Закреплен за предпоследним PRG банком
8k Слот @ $A000 = Переключаемый
8k Слот @ $C000 = Переключаемый
8k Слот @ $E000 = Закреплен за последним PRG банком

CHR:
2k Слот @ ppu$0000 = Переключаемый
2k Слот @ ppu$0800 = Переключаемый
1k Слот @ ppu$1000 = Переключаемый
1k Слот @ ppu$1400 = Переключаемый
1k Слот @ ppu$1800 = Переключаемый
1k Слот @ ppu$1C00 = Переключаемый
----------ИЛИ----------
1k Слот @ ppu$0000 = Переключаемый
1k Слот @ ppu$0400 = Переключаемый
1k Слот @ ppu$0800 = Переключаемый
1k Слот @ ppu$0C00 = Переключаемый
2k Слот @ ppu$1000 = Переключаемый
2k Слот @ ppu$1800 = Переключаемый</code></pre></li>
</ul>
<p><strong>Замечание напоследок</strong><br />
Когда речь идет о мапперах… Речь идет обо всем. “Маппер” - это практически комбинация схем картриджа, соединеняющих элементов, контроллера памяти и всего остального, что есть на картридже. Теоретически, на картридже возможно размещение дополнительного процессора!<br />
Таким образом “правил” для мапперов существовать не может. Весь этот материал нужно воспринимать, постоянно держа в голове, что он не высечен в камне… И что есть мапперы, которые выделяются из общей массы.</p><hr />
</div></body></html>