Итак, тема сегодняшнего урока: "поиск текста, словаря и указателей на то и другое в случае MTE методами отладки".
В качестве жертвы возьмем РОМ 'Adventures in the Magic Kingdom (U)'.

Откроем РОМ в FCEUXD SP и подойдем к девочке в северо-восточной части парка. Она должна сказать что-то вроде 'I'll tell you what...'
Итак, индекс первой буквы I расположен по адресу $2063 в памяти PPU. Поставим останов на запись в эту ячейку и подойдём к девочке еще раз. Первый раз останов сработает в процедуре очистки экрана. Для облегчения дальнейшего процесса анализа откроем Trace Logger и начнем сбрасывать трейс в файл. После срабатывания команды
$CF0D:8D 07 20  STA $2007 = #$00          
где A:12, трейсинг можно прекращать, так как все команды считывания этой буквы из РОМа уже выполнены и стопроцентно содержатся в нашем файле трейса.
Открываем файл и перемещаемся в его конец:
$CF0A:BD 00 04  LDA $0400,X @ $0419 = #$12 A:01 X:19 Y:01 P:nVUbdIzc
$CF0D:8D 07 20  STA $2007 = #$00           A:12 X:19 Y:01 P:nVUbdIzc

вводим в поиск $0419 и ищем вверх где происходит запись в эту ячейку.
$D012:B9 00 03  LDA $0300,Y @ $0301 = #$12 A:01 X:19 Y:01 P:nvUbdIzC
$D015:10 03     BPL $D01A                  A:12 X:19 Y:01 P:nvUbdIzC
$D01A:9D 00 04  STA $0400,X @ $0419 = #$24 A:12 X:19 Y:01 P:nvUbdIzC

аналогично поступаем и с $0301:
$CDB8:B1 F3     LDA ($F3),Y @ $BD12 = #$12 A:BD X:01 Y:00 P:nvUbdIZc
$CDBA:C9 FF     CMP #$FF                   A:12 X:01 Y:00 P:nvUbdIzc
$CDBC:F0 07     BEQ $CDC5                  A:12 X:01 Y:00 P:nvUbdIzc
$CDBE:C8        INY                        A:12 X:01 Y:00 P:nvUbdIzc
$CDBF:20 C8 CD  JSR $CDC8                  A:12 X:01 Y:01 P:nvUbdIzc
$CDC8:9D 00 03  STA $0300,X @ $0301 = #$24 A:12 X:01 Y:01 P:nvUbdIzc

Итак, искомая команда загрузки этой буквы из РОМа. Найдём это место: открываем хексредактор FCEUXD SP и переходим по адресу $BD12 в памяти приставки. Оказывается, по этому адресу нет искомого нами байта $12, что объясняется переключением банков. Зато мы точно знаем, что по этому адресу обязан быть наш байт при выполнении команды по адресу $CDB8. Поэтому ставим останов на выполнение этой команды и жмем RUN. Переключаемся обратно в хексредактор и видим наш байт $12 - затем, нажимая правую кнопку мыши и выбирая Go here in rom file, узнаем смещение этой буквы непосредственно в файле РОМа: это 0xFD22. Внимательно вглядимся в структуру окружающих байт. Уже по внешнему виду можно сказать, что это словарь MTE: множество несвязанных слов, разделенных контрольным байтом $FF. Таким нехитрым способом мы сразу нашли местоположение таблицы MTE. Перейдем к указателям на слова.

Вернемся к нашему трейсу и чуть выше команды загрузки видим:
$CDAC:B9 00 BB  LDA $BB00,Y @ $BB34 = #$12 A:00 X:01 Y:34 P:nvUbdIZc
$CDAF:85 F3     STA $00F3 = #$02           A:12 X:01 Y:34 P:nvUbdIzc
$CDB1:B9 80 BB  LDA $BB80,Y @ $BBB4 = #$BD A:12 X:01 Y:34 P:nvUbdIzc
$CDB4:85 F4     STA $00F4 = #$01           A:BD X:01 Y:34 P:NvUbdIzc

По адресу $BB00 хранятся младшие байты указателей на слова в словаре MTE, а $BB80 - старшие (очевидно, в словаре $80 слов). Воспользовавшись тем же методом, что и в случае поиска словаря, легко находим смещение в роме двух таблиц байтов указателей: 0xFB10 и 0xFB90. Переходим непосредственно к тексту.

Вернемся в наш трейс и, проанализировав процедуру загрузки, убеждаемся, что в Y, скорее всего, хранится номер слова из словаря MTE. А значит, при чтении скрипта, процедура должна прочитать номер слова, поместить его в Y и перейти к чтению указателей командой $CDAC. Немного проследив вверх значение в регистре Y ($34) натыкаемся на команду:
$CDA2:B1 51     LDA ($51),Y @ $A42E = #$34 A:01 X:01 Y:01 P:nvUbdIzc
$CDA4:A8        TAY                        A:34 X:01 Y:01 P:nvUbdIzc

Скорее всего, по адресу $A42E и будет расположен основной скрипт. Найдя его смещение в РОМе (0x643e) убеждаемся, что это и есть скрипт, так как после словарного слова I'll (слово номер $34 в словаре, перед которым стоит контрольный байт $F5) следует несловарное слово tell, которое представлено в явном виде. Таким образом, нам остается лишь найти таблицу указателей на эту строку в скрипте. В поиске вводим '$0051' и ищем команду записи в ячейку младшего байта указателя на строку скрипта:
$CC1A:B1 F3     LDA ($F3),Y @ $9A29 = #$2D A:9A X:04 Y:00 P:NvUbdIzc
$CC1C:85 51     STA $0051 = #$2B           A:2D X:04 Y:00 P:nvUbdIzc
$CC1E:A9 00     LDA #$00                   A:2D X:04 Y:00 P:nvUbdIzc
$CC20:18        CLC                        A:00 X:04 Y:00 P:nvUbdIZc
$CC21:65 14     ADC $0014 = #$29           A:00 X:04 Y:00 P:nvUbdIZc
$CC23:85 F3     STA $00F3 = #$29           A:29 X:04 Y:00 P:nvUbdIzc
$CC25:A9 9C     LDA #$9C                   A:29 X:04 Y:00 P:nvUbdIzc
$CC27:65 15     ADC $0015 = #$00           A:9C X:04 Y:00 P:NvUbdIzc
$CC29:85 F4     STA $00F4 = #$9A           A:9C X:04 Y:00 P:NvUbdIzc
$CC2B:B1 F3     LDA ($F3),Y @ $9C29 = #$A4 A:9C X:04 Y:00 P:NvUbdIzc
$CC2D:85 52     STA $0052 = #$DC           A:A4 X:04 Y:00 P:NvUbdIzc
Опять же две таблицы: с младшими и старшими байтами указателей по адресам $9A00 (в РОМе смещение 0x5A10) и $9C00 (0x5C10) (очевидно, в скрипте может быть до $200 сообщений).

И коротко, учитывая всё вышесказанное, расскажу о системе хранения текста в игре Little Ninja Brothers (U). 
Прежде всего, поставив бряк на запись в память PPU на первом экране заставки: 'One day, there was an emergency TV broadcast...' на букву 't' в слове 'there', вываливаемся вот в этом месте: 
$F41B:B9 41 01  LDA $0141,Y @ $0177 = #$1D A:22 X:01 Y:36 P:nvUbdIzC
$F41E:8D 07 20  STA $2007 = #$24           A:1D X:01 Y:36 P:nvUbdIzC

Выше находим запись в нашу ячейку RAM:
$F124:B9 00 FF  LDA $FF00,Y @ $FF68 = #$54 A:68 X:01 Y:68 P:nvUBdizc;загрузка номера буквы в алфавите - mte словарь на сочетание th
$F127:0A        ASL                        A:54 X:01 Y:68 P:nvUBdizc
$F128:90 11     BCC $F13B                  A:A8 X:01 Y:68 P:NvUBdizc
$F13B:4A        LSR                        A:A8 X:01 Y:68 P:NvUBdizc
$F13C:D0 29     BNE $F167                  A:54 X:01 Y:68 P:nvUBdizc
$F167:20 7C F1  JSR $F17C                  A:54 X:01 Y:68 P:nvUBdizc
$F17C:A6 4F     LDX $004F = #$35           A:54 X:01 Y:68 P:nvUBdizc
$F17E:A4 30     LDY $0030 = #$00           A:54 X:35 Y:68 P:nvUBdizc
$F180:C9 FF     CMP #$FF                   A:54 X:35 Y:00 P:nvUBdiZc
$F182:F0 05     BEQ $F189                  A:54 X:35 Y:00 P:nvUBdizc
$F184:29 7F     AND #$7F                   A:54 X:35 Y:00 P:nvUBdizc
$F186:20 A2 F0  JSR $F0A2                  A:54 X:35 Y:00 P:nvUBdizc
$F0A2:4C 6D F4  JMP $F46D                  A:54 X:35 Y:00 P:nvUBdizc
$F46D:84 30     STY $0030 = #$00           A:54 X:35 Y:00 P:nvUBdizc
$F46F:29 7F     AND #$7F                   A:54 X:35 Y:00 P:nvUBdizc
$F471:A8        TAY                        A:54 X:35 Y:00 P:nvUBdizc
$F472:A6 4F     LDX $004F = #$35           A:54 X:35 Y:54 P:nvUBdizc
$F474:B9 86 F8  LDA $F886,Y @ $F8DA = #$48 A:54 X:35 Y:54 P:nvUBdizc
$F477:C0 7A     CPY #$7A                   A:48 X:35 Y:54 P:nvUBdizc
$F479:B0 02     BCS $F47D                  A:48 X:35 Y:54 P:NvUBdizc
$F47B:A9 24     LDA #$24                   A:48 X:35 Y:54 P:NvUBdizc
$F47D:9D 41 01  STA $0141,X @ $0176 = #$24 A:24 X:35 Y:54 P:nvUBdizc
$F480:E8        INX                        A:24 X:35 Y:54 P:nvUBdizc
$F481:B9 06 F9  LDA $F906,Y @ $F95A = #$1D A:24 X:36 Y:54 P:nvUBdizc;F906-начало алфавита. Это загрузка самой буквы.
$F484:9D 41 01  STA $0141,X @ $0177 = #$27 A:1D X:36 Y:54 P:nvUBdizc

Перед этим было:
$F159:B9 00 FF  LDA $FF00,Y @ $FF11 = #$68 A:11 X:00 Y:11 P:nvUBdizc; загружаем смещение от начала краткого МТЕ словаря. 
$F15C:8D 33 01  STA $0133 = #$00           A:68 X:00 Y:11 P:nvUBdizc;В Y - номер слова в кратком словаре.
$F15F:A6 48     LDX $0048 = #$01           A:68 X:00 Y:11 P:nvUBdizc
$F161:D0 B9     BNE $F11C                  A:68 X:01 Y:11 P:nvUBdizc
$F11C:AC 33 01  LDY $0133 = #$68           A:68 X:01 Y:11 P:nvUBdizc
$F11F:F0 1D     BEQ $F13E                  A:68 X:01 Y:68 P:nvUBdizc 

Перед этим:
$F142:B1 4D     LDA ($4D),Y @ $BE53 = #$11 A:09 X:00 Y:00 P:nvUBdizC;загрузка the, после которого в мте таблице идет re, т.е. начало загрузки словарного слова there, 
$F144:10 0C     BPL $F152                  A:11 X:00 Y:00 P:nvUBdizC
$F152:C9 20     CMP #$20                   A:11 X:00 Y:00 P:nvUBdizC
$F154:B0 11     BCS $F167                  A:11 X:00 Y:00 P:NvUBdizc
$F156:29 7F     AND #$7F                   A:11 X:00 Y:00 P:NvUBdizc
$F158:A8        TAY                        A:11 X:00 Y:00 P:nvUBdizc

Выше:
$F106:B1 30     LDA ($30),Y @ $BA72 = #$53 A:00 X:00 Y:00 P:nvUBdiZC; в районе $BA72 таблица указателей
$F108:85 4D     STA $004D = #$72           A:53 X:00 Y:00 P:nvUBdizC
$F10A:C8        INY                        A:53 X:00 Y:00 P:nvUBdizC
$F10B:B1 30     LDA ($30),Y @ $BA73 = #$8E A:53 X:00 Y:01 P:nvUBdizC
$F10D:29 0F     AND #$0F                   A:8E X:00 Y:01 P:NvUBdizC
$F10F:09 B0     ORA #$B0                   A:0E X:00 Y:01 P:nvUBdizC
$F111:85 4E     STA $004E = #$BA           A:BE X:00 Y:01 P:NvUBdizC 

Выше:
$F0D1:B1 40     LDA ($40),Y @ $0149 = #$A9 A:02 X:00 Y:01 P:nvUBdizc
$F0D3:88        DEY                        A:A9 X:00 Y:01 P:NvUBdizc
$F0D4:85 30     STA $0030 = #$82           A:A9 X:00 Y:00 P:nvUBdiZc
$F0D6:0A        ASL                        A:A9 X:00 Y:00 P:nvUBdiZc
$F0D7:26 31     ROL $0031 = #$02           A:52 X:00 Y:00 P:nvUBdizC
$F0D9:D0 08     BNE $F0E3                  A:52 X:00 Y:00 P:nvUBdizc
$F0E3:18        CLC                        A:52 X:00 Y:00 P:nvUBdizc
$F0E4:69 20     ADC #$20                   A:52 X:00 Y:00 P:nvUBdizc
$F0E6:85 30     STA $0030 = #$A9           A:72 X:00 Y:00 P:nvUBdizc
$F0E8:A9 B5     LDA #$B5                   A:72 X:00 Y:00 P:nvUBdizc
$F0EA:65 31     ADC $0031 = #$05           A:B5 X:00 Y:00 P:NvUBdizc
$F0EC:85 31     STA $0031 = #$05           A:BA X:00 Y:00 P:NvUBdizc

выше
$8841:B1 C4     LDA ($C4),Y @ $0626 = #$A9 A:82 X:08 Y:06 P:nvUBdizc
$8843:9D 41 01  STA $0141,X @ $0149 = #$5B A:A9 X:08 Y:06 P:NvUBdizc

В $626, оказывается уже записано это выражение, внимательно приглядевшись, обнаруживаем, что в раме уже содержится скрипт, оптимизированный МТЕ.
Откатившись назад и поставив бряк на запись в эту область рама, делаем еще один трейс:

$F599:AD 07 20  LDA $2007 = #$A9           A:82 X:FF Y:06 P:NvUbdIzc
$F59C:91 40     STA ($40),Y @ $0626 = #$FF A:A9 X:FF Y:06 P:NvUbdIzc

Очевидно, непосредственно скрипт хранится в CHR-ROM банке,а непосредственно процедура загрузки выглядит так:
$F58A:A0 00     LDY #$00                   A:5E X:FF Y:01 P:nvUbdIzc
$F58C:A5 4C     LDA $004C = #$02           A:5E X:FF Y:00 P:nvUbdIZc
$F58E:8D 06 20  STA $2006 = #$00           A:02 X:FF Y:00 P:nvUbdIzc
$F591:A5 4B     LDA $004B = #$91           A:02 X:FF Y:00 P:nvUbdIzc
$F593:8D 06 20  STA $2006 = #$00           A:91 X:FF Y:00 P:NvUbdIzc; Установка порта адреса на чтение из 0291 в памяти PPU 
$F596:AD 07 20  LDA $2007 = #$24           A:91 X:FF Y:00 P:NvUbdIzc; первое чтение нелегально
$F599:AD 07 20  LDA $2007 = #$82           A:24 X:FF Y:00 P:nvUbdIzc
$F59C:91 40     STA ($40),Y @ $0620 = #$81 A:82 X:FF Y:00 P:NvUbdIzc; сохраняем в рам CPU

Увидев в момент бряка в окне PPU $0299, переходим в PPU Mem, ищем сочетание байт, которое сейчас находится в памяти PPU в РОМе и находим смещение нашего скрипта: 0x372A7.

-=#Griever's Stuff#=- 
       2008
